<!DOCTYPE html>
<html>
  <head>
    <title>Barra de progreso de carga</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link href="./css/styles.css" rel="stylesheet" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      .drop-zone {
        border: 3px dashed #ccc;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s;
        cursor: pointer;
        margin-bottom: 20px;
        background-color: #f8f9fa;
      }

      .drop-zone.dragover {
        border-color: #0d6efd;
        background-color: #e7f1ff;
        transform: scale(1.02);
      }

      .drop-zone p {
        margin: 0;
        color: #6c757d;
        font-size: 1.1rem;
      }

      .drop-zone.has-files {
        border-color: #198754;
        background-color: #d1e7dd;
      }
    </style>
  </head>
  <body>
    <div id="serverBadge" class="server-badge">
      <span class="server-loading">Conectando...</span>
    </div>
    <section class="marginform">
      <h1>Sube tus archivos</h1>

      <!-- Zona de drop -->
      <div class="drop-zone" id="dropZone">
        <p>
          üìÅ Arrastra tus archivos aqu√≠<br />
          <small>o haz clic para seleccionar</small>
        </p>
      </div>

      <div class="mb-3">
        <input
          class="form-control"
          type="file"
          name="file"
          id="fileInput"
          multiple
          style="display: none"
        />
        <div id="fileListDisplay" class="mt-2"></div>
      </div>

      <div class="mb-3">
        <input
          placeholder="Nombre para el archivo"
          class="form-control"
          type="text"
          name="files"
          id="nameFile"
        />
      </div>
      <div class="mb-3">
        <select id="category" class="form-select" aria-label="Categoria">
          <option value="df">Categoria</option>
          <option value="gameplay">Gameplay</option>
          <option value="private">Privado</option>
          <option value="edition">Edicion</option>
        </select>
      </div>

      <div id="progressBar" style="height: 20px; background-color: #f0f0f0">
        <div
          id="progress"
          style="width: 0%; height: 100%; background-color: #42b983"
        ></div>
      </div>

      <div class="d-grid gap-2 pt-2">
        <button
          onclick="uploadFiles()"
          class="btn btn-primary"
          id="submitButton"
        >
          Cargar archivos
        </button>
      </div>

      <!-- Collapse para las barras de progreso individuales -->
      <div class="mt-3">
        <button
          class="accordion-button"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#progressCollapse"
          aria-expanded="false"
          aria-controls="progressCollapse"
        >
          Ver progreso individual
        </button>
        <div class="collapse custom-collapse" id="progressCollapse">
          <div id="progressContainer" class="mt-2"></div>
        </div>
      </div>
    </section>

    <script>
      async function getServerInfo() {
        try {
          const response = await fetch("/server-info");
          const data = await response.json();

          const badge = document.getElementById("serverBadge");
         // badge.textContent = data.serverName;
         badge.textContent = ` ${data.hostname} / ${data.environment}`;
          badge.classList.add(data.environment);
        } catch (error) {
          console.error("Error obteniendo info del servidor:", error);
        }
      }

      getServerInfo();

      const barProgresv1 = document.getElementById("progress");
      const socket = io();
      const submitButton = document.getElementById("submitButton");
      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");
      const fileListDisplay = document.getElementById("fileListDisplay");

      let totalSize = 0;
      let fileProgress = {};
      let filesUploaded = 0;

      // ===== DRAG & DROP FUNCTIONALITY =====

      // Prevenir comportamiento por defecto
      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      // Resaltar zona cuando se arrastra
      ["dragenter", "dragover"].forEach((eventName) => {
        dropZone.addEventListener(
          eventName,
          () => {
            dropZone.classList.add("dragover");
          },
          false
        );
      });

      ["dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(
          eventName,
          () => {
            dropZone.classList.remove("dragover");
          },
          false
        );
      });

      // Manejar el evento drop
      dropZone.addEventListener("drop", handleDrop, false);

      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
      }

      // Click en la zona para abrir selector
      dropZone.addEventListener("click", () => {
        fileInput.click();
      });

      // Cuando se seleccionan archivos manualmente
      fileInput.addEventListener("change", (e) => {
        handleFiles(e.target.files);
      });

      // Procesar archivos seleccionados
      function handleFiles(files) {
        // Actualizar el input con los archivos
        fileInput.files = files;

        // Actualizar visualizaci√≥n
        updateFileList(files);

        // Cambiar apariencia de la zona
        if (files.length > 0) {
          dropZone.classList.add("has-files");
          dropZone.querySelector("p").innerHTML = `
            ‚úÖ ${files.length} archivo(s) seleccionado(s)<br>
            <small>Haz clic para cambiar la selecci√≥n</small>
          `;
        }
      }

      // Mostrar lista de archivos seleccionados
      function updateFileList(files) {
        fileListDisplay.innerHTML = "";

        if (files.length === 0) return;

        const list = document.createElement("div");
        list.className = "alert alert-info";
        list.innerHTML =
          '<strong>Archivos seleccionados:</strong><ul class="mb-0 mt-2">';

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const size = formatBytes(file.size);
          list.innerHTML += `<li>${file.name} (${size})</li>`;
        }

        list.innerHTML += "</ul>";
        fileListDisplay.appendChild(list);
      }

      // Formatear bytes
      function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (
          parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) +
          " " +
          sizes[i]
        );
      }

      // ===== ORIGINAL UPLOAD FUNCTIONALITY =====

      function uploadFiles() {
        const files = document.getElementById("fileInput").files;

        if (files.length === 0) {
          alert("Por favor selecciona o arrastra archivos primero");
          return;
        }

        const progressContainer = document.getElementById("progressContainer");
        progressContainer.innerHTML = "";

        totalSize = 0;
        fileProgress = {};
        filesUploaded = 0;

        submitButton.disabled = true;

        for (let i = 0; i < files.length; i++) {
          totalSize += files[i].size;
          fileProgress[files[i].name] = 0;
        }

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const progressBar = document.createElement("div");
          progressBar.className = "mb-2";
          progressBar.innerHTML = `
            <p><strong>${file.name}</strong></p>
            <progress max="100" value="0" style="width: 100%; height: 20px;"></progress>
          `;
          progressContainer.appendChild(progressBar);

          uploadFile(file, progressBar.querySelector("progress"));
        }
      }

      function uploadFile(file, progressBar) {
        const xhr = new XMLHttpRequest();
        xhr.open(
          "POST",
          "/upload?category=" +
            encodeURIComponent(document.getElementById("category").value)
        );

        xhr.upload.onprogress = (event) => {
          if (event.lengthComputable) {
            fileProgress[file.name] = event.loaded;

            const percentFile = Math.floor((event.loaded / file.size) * 100);
            progressBar.value = percentFile;

            updateGlobalProgress();
          }
        };

        xhr.onload = () => {
          if (xhr.status === 200) {
            progressBar.value = 100;
            filesUploaded++;

            socket.emit("uploadComplete", { fileName: file.name });

            if (
              filesUploaded ===
              document.getElementById("fileInput").files.length
            ) {
              submitButton.disabled = false;

              // Resetear la zona de drop
              dropZone.classList.remove("has-files");
              dropZone.querySelector("p").innerHTML = `
                üìÅ Arrastra tus archivos aqu√≠<br>
                <small>o haz clic para seleccionar</small>
              `;
              fileListDisplay.innerHTML = "";

              console.log(
                "Todos los archivos han sido subidos. Bot√≥n desbloqueado."
              );
            }
          }
        };

        const formData = new FormData();
        formData.append("file", file);
        xhr.send(formData);
      }

      function updateGlobalProgress() {
        const totalUploaded = Object.values(fileProgress).reduce(
          (acc, size) => acc + size,
          0
        );

        const percentGlobal = Math.floor((totalUploaded / totalSize) * 100);
        barProgresv1.style.width = `${percentGlobal}%`;

        if (percentGlobal > 100) {
          barProgresv1.style.width = "100%";
        }
      }

      socket.on("uploadComplete", (data) => {
        console.log(`Archivo ${data.fileName} subido con √©xito`);
      });
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
